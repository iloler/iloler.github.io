
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta name="referrer" content="no-referrer">
  
    <title>Elasticsearch笔记 | 养只阿柴捏脸玩</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Chen Peng">
    

    
    <meta name="description" content="背景使用的场景因业务需要加入关键字搜索功能，所以引入了 Elasticsearch（简称 es）。源数据存储在 mysql 中，新增数据时候，通过接口同步将数据放入 es。抽象一下，大致有以下几张表。question_content（题目内容表）    字段名 数据类型 备注     id bigint 主键   title text 题干   option_a varchar 选项 A   op">
<meta property="og:type" content="article">
<meta property="og:title" content="Elasticsearch笔记">
<meta property="og:url" content="http://chenpeng.github.io/2020/06/11/yuque/Elasticsearch笔记/index.html">
<meta property="og:site_name" content="养只阿柴捏脸玩">
<meta property="og:description" content="背景使用的场景因业务需要加入关键字搜索功能，所以引入了 Elasticsearch（简称 es）。源数据存储在 mysql 中，新增数据时候，通过接口同步将数据放入 es。抽象一下，大致有以下几张表。question_content（题目内容表）    字段名 数据类型 备注     id bigint 主键   title text 题干   option_a varchar 选项 A   op">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/592189/1592385919401-b0078959-715b-4923-b0eb-89e7ce6d2be7.png#align=left&display=inline&height=316&margin=%5Bobject%20Object%5D&name=image.png&originHeight=438&originWidth=731&size=32361&status=done&style=none&width=528">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/592189/1592450646659-be4423d7-1c38-4313-8c85-29db8ea05cf3.png#align=left&display=inline&height=285&margin=%5Bobject%20Object%5D&name=image.png&originHeight=570&originWidth=1192&size=140385&status=done&style=none&width=596">
<meta property="og:updated_time" content="2021-07-13T09:45:50.250Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elasticsearch笔记">
<meta name="twitter:description" content="背景使用的场景因业务需要加入关键字搜索功能，所以引入了 Elasticsearch（简称 es）。源数据存储在 mysql 中，新增数据时候，通过接口同步将数据放入 es。抽象一下，大致有以下几张表。question_content（题目内容表）    字段名 数据类型 备注     id bigint 主键   title text 题干   option_a varchar 选项 A   op">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/592189/1592385919401-b0078959-715b-4923-b0eb-89e7ce6d2be7.png#align=left&display=inline&height=316&margin=%5Bobject%20Object%5D&name=image.png&originHeight=438&originWidth=731&size=32361&status=done&style=none&width=528">

    
    <link rel="alternative" href="/atom.xml" title="养只阿柴捏脸玩" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="养只阿柴捏脸玩" title="养只阿柴捏脸玩"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="养只阿柴捏脸玩">养只阿柴捏脸玩</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:chenpeng.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/06/11/yuque/Elasticsearch笔记/" title="Elasticsearch笔记" itemprop="url">Elasticsearch笔记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Chen Peng" target="_blank" itemprop="author">Chen Peng</a>
		
  <p class="article-time">
    <time datetime="2020-06-11T02:44:06.000Z" itemprop="datePublished"> 发表于 2020-06-11</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用的场景"><span class="toc-number">1.1.</span> <span class="toc-text">使用的场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务不满意"><span class="toc-number">1.2.</span> <span class="toc-text">业务不满意</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#技术实现"><span class="toc-number">2.</span> <span class="toc-text">技术实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备"><span class="toc-number">2.1.</span> <span class="toc-text">准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群"><span class="toc-number">2.1.2.</span> <span class="toc-text">集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件"><span class="toc-number">2.1.3.</span> <span class="toc-text">插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试分词"><span class="toc-number">2.1.4.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析器"><span class="toc-number">2.2.</span> <span class="toc-text">分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#character_filters"><span class="toc-number">2.2.1.</span> <span class="toc-text">character filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tokenizers"><span class="toc-number">2.2.2.</span> <span class="toc-text">tokenizers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token_filters"><span class="toc-number">2.2.3.</span> <span class="toc-text">token filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义"><span class="toc-number">2.2.4.</span> <span class="toc-text">自定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引"><span class="toc-number">2.3.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新建索引"><span class="toc-number">2.3.1.</span> <span class="toc-text">新建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询索引"><span class="toc-number">2.3.2.</span> <span class="toc-text">查询索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除索引"><span class="toc-number">2.3.3.</span> <span class="toc-text">删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#映射（mapping）"><span class="toc-number">2.3.4.</span> <span class="toc-text">映射（mapping）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy_to"><span class="toc-number">2.3.5.</span> <span class="toc-text">copy_to</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态映射（dynamic_mapping）"><span class="toc-number">2.3.6.</span> <span class="toc-text">动态映射（dynamic mapping）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置（_settings）"><span class="toc-number">2.3.7.</span> <span class="toc-text">设置（_settings）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模版（_template）"><span class="toc-number">2.4.</span> <span class="toc-text">模版（_template）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建模版"><span class="toc-number">2.4.1.</span> <span class="toc-text">创建模版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询模版"><span class="toc-number">2.4.2.</span> <span class="toc-text">查询模版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用模版"><span class="toc-number">2.4.3.</span> <span class="toc-text">使用模版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文档_CRUD"><span class="toc-number">2.5.</span> <span class="toc-text">文档 CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新增文档"><span class="toc-number">2.5.1.</span> <span class="toc-text">新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看文档"><span class="toc-number">2.5.2.</span> <span class="toc-text">查看文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新文档"><span class="toc-number">2.5.3.</span> <span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除文档"><span class="toc-number">2.5.4.</span> <span class="toc-text">删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量新增"><span class="toc-number">2.5.5.</span> <span class="toc-text">批量新增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量获取"><span class="toc-number">2.5.6.</span> <span class="toc-text">批量获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量查询"><span class="toc-number">2.5.7.</span> <span class="toc-text">批量查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搜索"><span class="toc-number">2.6.</span> <span class="toc-text">搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#衡量相关性"><span class="toc-number">2.6.1.</span> <span class="toc-text">衡量相关性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URI_Search"><span class="toc-number">2.6.2.</span> <span class="toc-text">URI Search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request_Body_Search"><span class="toc-number">2.6.3.</span> <span class="toc-text">Request Body Search</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#match"><span class="toc-number">2.6.3.1.</span> <span class="toc-text">match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match_phrase"><span class="toc-number">2.6.3.2.</span> <span class="toc-text">match_phrase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#term"><span class="toc-number">2.6.3.3.</span> <span class="toc-text">term</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#terms"><span class="toc-number">2.6.3.4.</span> <span class="toc-text">terms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#filter"><span class="toc-number">2.6.3.5.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range"><span class="toc-number">2.6.3.6.</span> <span class="toc-text">range</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#explain"><span class="toc-number">2.6.3.7.</span> <span class="toc-text">explain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bool,must,should，must_not"><span class="toc-number">2.6.3.8.</span> <span class="toc-text">bool,must,should，must_not</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boost"><span class="toc-number">2.6.3.9.</span> <span class="toc-text">boost</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boosting"><span class="toc-number">2.6.3.10.</span> <span class="toc-text">boosting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#profile"><span class="toc-number">2.6.3.11.</span> <span class="toc-text">profile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分页（from,size）"><span class="toc-number">2.6.3.12.</span> <span class="toc-text">分页（from,size）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#深度分页（search_after）"><span class="toc-number">2.6.3.13.</span> <span class="toc-text">深度分页（search_after）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#深度分页(scroll)"><span class="toc-number">2.6.3.14.</span> <span class="toc-text">深度分页(scroll)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_source"><span class="toc-number">2.6.3.15.</span> <span class="toc-text">_source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sort"><span class="toc-number">2.6.3.16.</span> <span class="toc-text">sort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#script_field"><span class="toc-number">2.6.3.17.</span> <span class="toc-text">script_field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#query_string"><span class="toc-number">2.6.3.18.</span> <span class="toc-text">query_string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#聚合（aggregation）"><span class="toc-number">2.6.3.19.</span> <span class="toc-text">聚合（aggregation）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多值"><span class="toc-number">2.6.3.20.</span> <span class="toc-text">多值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dis_max"><span class="toc-number">2.6.3.21.</span> <span class="toc-text">dis_max</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#multi_match"><span class="toc-number">2.6.3.22.</span> <span class="toc-text">multi_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#search_template"><span class="toc-number">2.6.3.23.</span> <span class="toc-text">search_template</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#function_score_query"><span class="toc-number">2.6.3.24.</span> <span class="toc-text">function score query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#suggester"><span class="toc-number">2.6.3.25.</span> <span class="toc-text">suggester</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#completion_suggester"><span class="toc-number">2.6.3.26.</span> <span class="toc-text">completion suggester</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#高亮"><span class="toc-number">2.6.3.27.</span> <span class="toc-text">高亮</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态词库"><span class="toc-number">2.7.</span> <span class="toc-text">动态词库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重建索引"><span class="toc-number">2.8.</span> <span class="toc-text">重建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#update_by_query"><span class="toc-number">2.8.1.</span> <span class="toc-text">update by query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reindex"><span class="toc-number">2.8.2.</span> <span class="toc-text">reindex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#别名"><span class="toc-number">2.8.3.</span> <span class="toc-text">别名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据建模"><span class="toc-number">2.9.</span> <span class="toc-text">数据建模</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nested_data_type"><span class="toc-number">2.9.1.</span> <span class="toc-text">nested data type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#父子文档"><span class="toc-number">2.9.2.</span> <span class="toc-text">父子文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#script"><span class="toc-number">2.9.3.</span> <span class="toc-text">script</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h1 id="背景">背景</h1><h2 id="使用的场景">使用的场景</h2><p>因业务需要加入关键字搜索功能，所以引入了 Elasticsearch（简称 es）。<br>源数据存储在 mysql 中，新增数据时候，通过接口同步将数据放入 es。抽象一下，大致有以下几张表。<br>question_content（题目内容表）</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>title</td>
<td>text</td>
<td>题干</td>
</tr>
<tr>
<td>option_a</td>
<td>varchar</td>
<td>选项 A</td>
</tr>
<tr>
<td>option_b</td>
<td>varchar</td>
<td>选项 B</td>
</tr>
<tr>
<td>option_c</td>
<td>varchar</td>
<td>选项 C</td>
</tr>
<tr>
<td>option_d</td>
<td>varchar</td>
<td>选项 D</td>
</tr>
<tr>
<td>answer</td>
<td>varchar</td>
<td>答案</td>
</tr>
<tr>
<td>analysis</td>
<td>text</td>
<td>解析</td>
</tr>
<tr>
<td>create_time</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
</tbody>
</table>
<p>question_tag（题目标签表）</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>question_id</td>
<td>bigint</td>
<td>题目主键</td>
</tr>
<tr>
<td>grade_id</td>
<td>int</td>
<td>年级 id</td>
</tr>
<tr>
<td>subject_id</td>
<td>int</td>
<td>学科 id</td>
</tr>
<tr>
<td>score</td>
<td>double</td>
<td>分数</td>
</tr>
</tbody>
</table>
<p>question_knowledge（题目和知识点对应关系表）</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>question_id</td>
<td>bigint</td>
<td>题目主键</td>
</tr>
<tr>
<td>knowledge_id</td>
<td>bigint</td>
<td>知识点主键</td>
</tr>
</tbody>
</table>
<p>knowledge（知识点表）</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>数据类型</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>主键</td>
</tr>
<tr>
<td>name</td>
<td>varchar</td>
<td>知识点名称</td>
</tr>
</tbody>
</table>
<p>将这几张表的数据整合一下，合并成一个索引，放入 es 中。按照关键字查询的时候，使用 match 就完事了。</p>
<h2 id="业务不满意">业务不满意</h2><p>平时局限于能用就行，也没时间好好研究一下。最近因为业务对于搜索结果不满意，遂准备着手优化一下。</p>
<h1 id="技术实现">技术实现</h1><h2 id="准备">准备</h2><p>目前生产环境使用的 es，版本是 2.4。相对来说有点老，这次准备直接采用 es7.x。</p>
<h3 id="安装">安装</h3><p>下载安装之类的就不谈了，直接<a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">下载</a>，或者搞个 docker 安装一下。笔者用的 Mac，直接开启命令行搞定。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.7.1-darwin-x86_64.tar.gz</span><br><span class="line">tar -xzvf elasticsearch-7.7.1-darwin-x86_64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> elasticsearch-7.7.1</span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure>
<p>命令行执行以下命令。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1:9200</span><br></pre></td></tr></table></figure>
<p>正常情况下，会返回如下提示，则启动成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"chenpengdeMacBook-Pro.local"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"XNNrSOWsQyeYPeNSxdl-qg"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.7.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"tar"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"ad56dce891c901a492bb1ee393f12dfff473a423"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2020-05-28T16:30:01.040088Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.5.1"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集群">集群</h3><p>通过以下命令，再启动 2 个节点，形成一个 3 节点的集群。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./elasticsearch -Epath.data=data2 -Epath.logs=log2</span><br><span class="line">./elasticsearch -Epath.data=data3 -Epath.logs=log3</span><br></pre></td></tr></table></figure>
<p>通过 es 提供的 cat 查询语句，可以查看集群状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET http://localhost:9200/_cat/health?v</span><br></pre></td></tr></table></figure>
<p>返回如下提示，其中 status 为 green，表示集群状态是健康的。如果是单节点，status 是 yellow，功能都可以正常使用。如果 status 是 red，此时 es 不可用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">epoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent</span><br><span class="line">1591758070 03:01:10  elasticsearch green           3         3      0   0    0    0        0             0                  -                100.0%</span><br></pre></td></tr></table></figure>
<p>注意：遇到集群起来，索引分片无法分配的问题。因为磁盘空间使用超过了 80%导致的，通过以下命令调大一些。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/_cluster/settings'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "transient": &#123;</span></span><br><span class="line"><span class="string">        "cluster.routing.allocation.disk.watermark.low": "90%"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>Elastic search 的 Query DSL 通用格式为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X&lt;VERB&gt; <span class="string">'&lt;PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;/&lt;PATH&gt;?&lt;QUERY_STRING&gt;'</span> -d <span class="string">'&lt;BODY&gt;'</span></span><br></pre></td></tr></table></figure>
<h3 id="插件">插件</h3><p>既然是为了搜索，最重要的就是分词啦，需要安装分词插件。因为之前一直用的 ik，现在也不折腾了，继续用 ik 吧。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.3.0/elasticsearch-analysis-ik-6.3.0.zip</span><br></pre></td></tr></table></figure>
<p>加完插件，记得重启一下 es，再通过以下命令查看插件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/_cat/plugins'</span></span><br></pre></td></tr></table></figure>
<h3 id="测试分词">测试分词</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/_analyze'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"analyzer":"ik_max_word",</span></span><br><span class="line"><span class="string">	"text":"各个国家有各个国家的国歌"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="分析器">分析器</h2><p>直接使用默认的分析器 analyzer，或许不能满足需求，需要定制一个。本人所在的组代号 TK，那么自定义的分词器就叫 tk_analyzer 吧。<br>默认的 analyzer 包含了 3 块，分别是 character filters, tokenizers, token filters。</p>
<h3 id="character_filters">character filters</h3><p>预处理</p>
<ul>
<li>html_strip 这个 filter 可以去掉 html，比如文本是<code>&lt;p&gt;I&#39;m so &lt;b&gt;happy&lt;/b&gt;!&lt;/p&gt;</code>，过滤完变成了<code>\nI&#39;m so happy!\n</code>。公司的业务使用了富文本编辑内容，所以会有部分的 html 标签，以及一些自定义的标签，比如<zm-latex></zm-latex>这种。貌似有个 escaped_tags 参数，表示不需要过滤的 html 标签。</li>
<li>mapping character filter 可以将字符做一个映射，比如把:)映射成 happy。</li>
<li>pattern replace 正则匹配替换。</li>
</ul>
<h3 id="tokenizers">tokenizers</h3><p>分词<br>显然笔者不会去使用 standard，既然安装了 ik 插件，当然使用 ik 分词了。之前用的 ik_smart，感觉不太好。这次选择 ik_max_word 试试。还有个参数 max_token_length 可以设置一下，默认 255。</p>
<h3 id="token_filters">token filters</h3><p>分词处理</p>
<ul>
<li>Lowercase token filter，顾名思义，将原文本规范为小写字母。</li>
<li>Stop token filter，停止词，表示忽略这些词，常见的英语里的 this，that，the，中文里的“的”，“地”，“得”。</li>
</ul>
<h3 id="自定义">自定义</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    curl --location --request PUT <span class="string">'localhost:9200/question'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "settings": &#123;</span></span><br><span class="line"><span class="string">        "analysis": &#123;</span></span><br><span class="line"><span class="string">            "analyzer": &#123;</span></span><br><span class="line"><span class="string">                "tk-analyzer": &#123;</span></span><br><span class="line"><span class="string">                    "type": "custom",</span></span><br><span class="line"><span class="string">                    "char_filter": [</span></span><br><span class="line"><span class="string">                        "html_strip",</span></span><br><span class="line"><span class="string">                        "tk-tag"</span></span><br><span class="line"><span class="string">                    ],</span></span><br><span class="line"><span class="string">                    "tokenizer": "tk-tokenizer",</span></span><br><span class="line"><span class="string">                    "filter": [</span></span><br><span class="line"><span class="string">                        "lowercase",</span></span><br><span class="line"><span class="string">                        "tk-filter"</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "char_filter": &#123;</span></span><br><span class="line"><span class="string">                "tk-tag": &#123;</span></span><br><span class="line"><span class="string">                    "type": "mapping",</span></span><br><span class="line"><span class="string">                    "mappings": [</span></span><br><span class="line"><span class="string">                        "&lt;zm-latex&gt; =&gt; ",</span></span><br><span class="line"><span class="string">                        "&lt;/zm-latex&gt; =&gt; "</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "tokenizer": &#123;</span></span><br><span class="line"><span class="string">                "tk-tokenizer": &#123;</span></span><br><span class="line"><span class="string">                    "type": "ik_max_word"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "filter": &#123;</span></span><br><span class="line"><span class="string">                "tk-filter": &#123;</span></span><br><span class="line"><span class="string">                    "type": "stop",</span></span><br><span class="line"><span class="string">                    "stopwords": [</span></span><br><span class="line"><span class="string">                        "a",</span></span><br><span class="line"><span class="string">                        "b"</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>用刚刚创建的分析器，试验一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_analyze'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"analyzer":"tk-analyzer",</span></span><br><span class="line"><span class="string">	"text":"&lt;body&gt;我的身体是我自己的&lt;zm-latex&gt;呵呵呵a b cDeFg&lt;/zm-latex&gt;&lt;/body&gt;"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>看一下返回结果，自定义的分析器起作用了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"tokens"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"我"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 6,</span><br><span class="line">            <span class="string">"end_offset"</span>: 7,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_CHAR"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"的"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 7,</span><br><span class="line">            <span class="string">"end_offset"</span>: 8,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_CHAR"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"身体"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 8,</span><br><span class="line">            <span class="string">"end_offset"</span>: 10,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_WORD"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"是"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 10,</span><br><span class="line">            <span class="string">"end_offset"</span>: 11,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_CHAR"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"我"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 11,</span><br><span class="line">            <span class="string">"end_offset"</span>: 12,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_CHAR"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 4</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"自己"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 12,</span><br><span class="line">            <span class="string">"end_offset"</span>: 14,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_WORD"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 5</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"的"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 14,</span><br><span class="line">            <span class="string">"end_offset"</span>: 15,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_CHAR"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 6</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"呵呵"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 25,</span><br><span class="line">            <span class="string">"end_offset"</span>: 27,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_WORD"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 7</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"呵呵"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 26,</span><br><span class="line">            <span class="string">"end_offset"</span>: 28,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"CN_WORD"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 8</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"token"</span>: <span class="string">"cdefg"</span>,</span><br><span class="line">            <span class="string">"start_offset"</span>: 32,</span><br><span class="line">            <span class="string">"end_offset"</span>: 37,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"ENGLISH"</span>,</span><br><span class="line">            <span class="string">"position"</span>: 10</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="索引">索引</h2><h3 id="新建索引">新建索引</h3><p>通过以下命令，创建一个名为“question”的 index。新版 es 已经不需要创建 type 了，默认_doc。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/question'</span></span><br></pre></td></tr></table></figure>
<p>返回了一些信息，表示创建成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"shards_acknowledged"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"index"</span>: <span class="string">"question"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查询索引">查询索引</h3><p>通过 GET 请求，查询一下刚刚创建的索引。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question'</span></span><br></pre></td></tr></table></figure>
<p>通过返回的信息，可以看到一些信息。没有设置别名（aliases），没有设置映射（mappings），所以这两个参数是空的。settings 里面可以看到目前有 1 个分片，1 个副本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"question"</span>: &#123;</span><br><span class="line">        <span class="string">"aliases"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"mappings"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"settings"</span>: &#123;</span><br><span class="line">            <span class="string">"index"</span>: &#123;</span><br><span class="line">                <span class="string">"creation_date"</span>: <span class="string">"1591775043188"</span>,</span><br><span class="line">                <span class="string">"number_of_shards"</span>: <span class="string">"1"</span>,</span><br><span class="line">                <span class="string">"number_of_replicas"</span>: <span class="string">"1"</span>,</span><br><span class="line">                <span class="string">"uuid"</span>: <span class="string">"ePSEJaUsR-qsFPrTbMEFQA"</span>,</span><br><span class="line">                <span class="string">"version"</span>: &#123;</span><br><span class="line">                    <span class="string">"created"</span>: <span class="string">"7070199"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"provided_name"</span>: <span class="string">"question"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除索引">删除索引</h3><p>通过以下命令即可删除索引。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request DELETE <span class="string">'localhost:9200/question'</span></span><br></pre></td></tr></table></figure>
<h3 id="映射（mapping）">映射（mapping）</h3><p>通过以下命令，设置一下 mapping。对于文本类型的数据格式，最好严格区分 text 和 keyword 类型，默认会使用 string 类型，同时使用（text,keyword）占了额外的空间，有点浪费空间。需要分词的字段 analyzer 设置为 ik_smart 和 ik_max_word，ik_smart 分词粒度较粗，ik_max_word 分词粒度较细。根据实际使用场景选择。<br>注：测试问我，为什么输入一个数字“8”，查不到名为“88888888”的试卷。因为试卷名称 name 字段 analyzer 设置的 ik_smart，考虑换成 ik_max_word。搜索的时候，结合 match_phrase 和 slop 调整顺序和精度。同时，对 text 再设置一下 standard，切割为单个汉字，提高业务查询的满意度。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_mapping'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "properties": &#123;</span></span><br><span class="line"><span class="string">        "id": &#123;</span></span><br><span class="line"><span class="string">            "type": "long"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "title": &#123;</span></span><br><span class="line"><span class="string">            "type": "text",</span></span><br><span class="line"><span class="string">            "analyzer": "ik_max_word",</span></span><br><span class="line"><span class="string">            "fields": &#123;</span></span><br><span class="line"><span class="string">            "standard": &#123;</span></span><br><span class="line"><span class="string">             "type": "text",</span></span><br><span class="line"><span class="string">             "analyzer": "standard"</span></span><br><span class="line"><span class="string">           &#125;,</span></span><br><span class="line"><span class="string">           "keyword": &#123;</span></span><br><span class="line"><span class="string">              "type": "keyword",</span></span><br><span class="line"><span class="string">             "ignore_above": 256</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">         &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "optionList": &#123;</span></span><br><span class="line"><span class="string">            "type": "text",</span></span><br><span class="line"><span class="string">            "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "answer": &#123;</span></span><br><span class="line"><span class="string">            "type": "text",</span></span><br><span class="line"><span class="string">            "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "analysis": &#123;</span></span><br><span class="line"><span class="string">            "type": "text",</span></span><br><span class="line"><span class="string">            "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "createTime": &#123;</span></span><br><span class="line"><span class="string">            "type": "long"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "gradeId": &#123;</span></span><br><span class="line"><span class="string">            "type": "integer"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "subjectId": &#123;</span></span><br><span class="line"><span class="string">            "type": "integer"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "score": &#123;</span></span><br><span class="line"><span class="string">            "type": "float"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "knowledgeList": &#123;</span></span><br><span class="line"><span class="string">            "properties": &#123;</span></span><br><span class="line"><span class="string">                "id": &#123;</span></span><br><span class="line"><span class="string">                    "type": "integer"</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "name": &#123;</span></span><br><span class="line"><span class="string">                    "type": "keyword"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="copy_to">copy_to</h3><p>实际需求中，题目有关联一个主知识点，N 个副知识点。建立 mapping 的时候，可以在 mainKnowledge 和 knowledge 字段，加上 copy_to 属性。以后查询知识点，只需要根据“knowledgeIdList”查询即可。注：“knowledgeIdList”这个字段不在返回的“_source”里。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/test_question'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "mappings":&#123;</span></span><br><span class="line"><span class="string">        "_source":&#123;</span></span><br><span class="line"><span class="string">            "enabled":false</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "properties":&#123;</span></span><br><span class="line"><span class="string">            "analysis":&#123;</span></span><br><span class="line"><span class="string">                "type":"text",</span></span><br><span class="line"><span class="string">                "analyzer":"ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "answer":&#123;</span></span><br><span class="line"><span class="string">                "type":"text",</span></span><br><span class="line"><span class="string">                "analyzer":"ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "createTime":&#123;</span></span><br><span class="line"><span class="string">                "type":"long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "gradeId":&#123;</span></span><br><span class="line"><span class="string">                "type":"long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "id":&#123;</span></span><br><span class="line"><span class="string">                "type":"long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "knowledgeList":&#123;</span></span><br><span class="line"><span class="string">                "properties":&#123;</span></span><br><span class="line"><span class="string">                    "id":&#123;</span></span><br><span class="line"><span class="string">                        "type":"long",</span></span><br><span class="line"><span class="string">                        "copy_to":"knowledgeIdList"</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "name":&#123;</span></span><br><span class="line"><span class="string">                        "type":"keyword"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "mainKnowledge":&#123;</span></span><br><span class="line"><span class="string">                "properties":&#123;</span></span><br><span class="line"><span class="string">                    "id":&#123;</span></span><br><span class="line"><span class="string">                        "type":"long",</span></span><br><span class="line"><span class="string">                        "copy_to":"knowledgeIdList"</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "name":&#123;</span></span><br><span class="line"><span class="string">                        "type":"keyword"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "optionList":&#123;</span></span><br><span class="line"><span class="string">                "type":"text",</span></span><br><span class="line"><span class="string">                "analyzer":"ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "score":&#123;</span></span><br><span class="line"><span class="string">                "type":"float"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "subjectId":&#123;</span></span><br><span class="line"><span class="string">                "type":"long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "title":&#123;</span></span><br><span class="line"><span class="string">                "type":"text",</span></span><br><span class="line"><span class="string">                "fields":&#123;</span></span><br><span class="line"><span class="string">                    "keyword":&#123;</span></span><br><span class="line"><span class="string">                        "type":"keyword",</span></span><br><span class="line"><span class="string">                        "ignore_above":256</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "standard":&#123;</span></span><br><span class="line"><span class="string">                        "type":"text",</span></span><br><span class="line"><span class="string">                        "analyzer":"standard"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "analyzer":"ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "settings":&#123;</span></span><br><span class="line"><span class="string">        "number_of_shards":"1",</span></span><br><span class="line"><span class="string">        "number_of_replicas":"2"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="动态映射（dynamic_mapping）">动态映射（dynamic mapping）</h3><p>如果没有手动设置 mapping 的字段类型的话，es 会根据 json 数据的格式，自动设置 mapping 的字段类型。我觉得设置 mapping 的时候，最好把 dynamic 设置为 strict，新字段写入直接报错，保险一点。<br><img src="https://cdn.nlark.com/yuque/0/2020/png/592189/1592385919401-b0078959-715b-4923-b0eb-89e7ce6d2be7.png#align=left&amp;display=inline&amp;height=316&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=438&amp;originWidth=731&amp;size=32361&amp;status=done&amp;style=none&amp;width=528" alt="image.png"></p>
<h3 id="设置（_settings）">设置（_settings）</h3><p>通过_settings 设置一下索引的相关参数，比如改一下 number_of_replicas，增加 2 个副本数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/question/_settings'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "index" : &#123;</span></span><br><span class="line"><span class="string">        "number_of_replicas" : 2</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="模版（_template）">模版（_template）</h2><p>有时候会有这种需求，每天一个索引，除了索引名，其他都相同。这个时候可以搞个模版，方便建立索引。</p>
<h3 id="创建模版">创建模版</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/_template/template_question'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"index_patterns":["question*"],</span></span><br><span class="line"><span class="string">    "aliases": &#123;</span></span><br><span class="line"><span class="string">        "question": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "mappings": &#123;</span></span><br><span class="line"><span class="string">        "_source": &#123;</span></span><br><span class="line"><span class="string">            "enabled": true</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "properties": &#123;</span></span><br><span class="line"><span class="string">            "analysis": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "answer": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "createTime": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "gradeId": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "id": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "knowledgeList": &#123;</span></span><br><span class="line"><span class="string">                "properties": &#123;</span></span><br><span class="line"><span class="string">                    "id": &#123;</span></span><br><span class="line"><span class="string">                        "type": "long"</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "name": &#123;</span></span><br><span class="line"><span class="string">                        "type": "keyword"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "optionList": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "score": &#123;</span></span><br><span class="line"><span class="string">                "type": "float"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "subjectId": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "title": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "fields": &#123;</span></span><br><span class="line"><span class="string">                    "keyword": &#123;</span></span><br><span class="line"><span class="string">                        "type": "keyword",</span></span><br><span class="line"><span class="string">                        "ignore_above": 256</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "standard": &#123;</span></span><br><span class="line"><span class="string">                        "type": "text",</span></span><br><span class="line"><span class="string">                        "analyzer": "standard"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "settings": &#123;</span></span><br><span class="line"><span class="string">        "number_of_shards": "1",</span></span><br><span class="line"><span class="string">        "number_of_replicas": "2"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="查询模版">查询模版</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/_template/template_question'</span></span><br></pre></td></tr></table></figure>
<h3 id="使用模版">使用模版</h3><p>=.=不是很明白怎么用</p>
<h2 id="文档_CRUD">文档 CRUD</h2><h3 id="新增文档">新增文档</h3><p>可以设置 id，不设置的话（url 不带上“/:id”），es 会默认分配唯一的 string 类型的 id。如果 id 已经存在的话，会覆盖并更新“_version”字段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_doc/1'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "title": "&lt;p&gt;与下面句子衔接最恰当的一项是 （  ）&lt;/p&gt;&lt;p&gt;　　克林顿当选为美国总统，成为举世瞩日的风云人物。当谈及自己的成长经历时，总统先生不无感慨地表示：这完全得益于中学时代的一次总统模拟活动。 &lt;span style=\"text-emphasis: none;-webkit-text-emphasis:none;\"&gt;&lt;zmsubline contenteditable=\"false\" answer-str=\"\"&gt;空类2&lt;/zmsubline&gt;&lt;/span&gt;。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "optionList": [</span></span><br><span class="line"><span class="string">        "&lt;p&gt;从小立大志，定能从此走向辉煌 。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;学生时代的生活经历，对人的影响实在重要。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;想把理想变为现实，就一定要经历生活的磨难。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;多方面开展模仿活动，对人的成长不无裨益。&lt;/p&gt;"</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "answer": "B",</span></span><br><span class="line"><span class="string">    "analysis": "&lt;p&gt;保持中心统一。即所有的句子都要围绕一个中心，不能出现离群句。 &lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "create_time": 1521971297000,</span></span><br><span class="line"><span class="string">    "gradeId": 1,</span></span><br><span class="line"><span class="string">    "subjectId": 1,</span></span><br><span class="line"><span class="string">    "score": 3,</span></span><br><span class="line"><span class="string">    "knowledgeList": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 1,</span></span><br><span class="line"><span class="string">            "name": "基本不等式与最大（小）值"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 2,</span></span><br><span class="line"><span class="string">            "name": "函数的零点"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>也可以通过“_create”新建（PUT 方法），区别是如果 id 已经存在的话，会返回失败。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/question/_create/1'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "title": "&lt;p&gt;与下面句子衔接最恰当的一项是 （  ）&lt;/p&gt;&lt;p&gt;　　克林顿当选为美国总统，成为举世瞩日的风云人物。当谈及自己的成长经历时，总统先生不无感慨地表示：这完全得益于中学时代的一次总统模拟活动。 &lt;span style=\"text-emphasis: none;-webkit-text-emphasis:none;\"&gt;&lt;zmsubline contenteditable=\"false\" answer-str=\"\"&gt;空类2&lt;/zmsubline&gt;&lt;/span&gt;。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "optionList": [</span></span><br><span class="line"><span class="string">        "&lt;p&gt;从小立大志，定能从此走向辉煌 。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;学生时代的生活经历，对人的影响实在重要。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;想把理想变为现实，就一定要经历生活的磨难。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;多方面开展模仿活动，对人的成长不无裨益。&lt;/p&gt;"</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "answer": "B",</span></span><br><span class="line"><span class="string">    "analysis": "&lt;p&gt;保持中心统一。即所有的句子都要围绕一个中心，不能出现离群句。 &lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "createTime": 1521971297000,</span></span><br><span class="line"><span class="string">    "gradeId": 1,</span></span><br><span class="line"><span class="string">    "subjectId": 1,</span></span><br><span class="line"><span class="string">    "score": 3,</span></span><br><span class="line"><span class="string">    "knowledgeList": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 1,</span></span><br><span class="line"><span class="string">            "name": "基本不等式与最大（小）值"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 2,</span></span><br><span class="line"><span class="string">            "name": "函数的零点"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>返回信息可以看到，提示已经存在。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"error"</span>: &#123;</span><br><span class="line">        <span class="string">"root_cause"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"version_conflict_engine_exception"</span>,</span><br><span class="line">                <span class="string">"reason"</span>: <span class="string">"[1]: version conflict, document already exists (current version [2])"</span>,</span><br><span class="line">                <span class="string">"index_uuid"</span>: <span class="string">"T-GUN_XCTlivoJz6QQX_Cg"</span>,</span><br><span class="line">                <span class="string">"shard"</span>: <span class="string">"0"</span>,</span><br><span class="line">                <span class="string">"index"</span>: <span class="string">"question"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"type"</span>: <span class="string">"version_conflict_engine_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span>: <span class="string">"[1]: version conflict, document already exists (current version [2])"</span>,</span><br><span class="line">        <span class="string">"index_uuid"</span>: <span class="string">"T-GUN_XCTlivoJz6QQX_Cg"</span>,</span><br><span class="line">        <span class="string">"shard"</span>: <span class="string">"0"</span>,</span><br><span class="line">        <span class="string">"index"</span>: <span class="string">"question"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"status"</span>: 409</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看文档">查看文档</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_doc/1'</span></span><br></pre></td></tr></table></figure>
<h3 id="更新文档">更新文档</h3><p>刚刚知识点写错了，怎么修改呢？其实和新增一样就可以修改了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_doc/1'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "title": "&lt;p&gt;与下面句子衔接最恰当的一项是 （  ）&lt;/p&gt;&lt;p&gt;　　克林顿当选为美国总统，成为举世瞩日的风云人物。当谈及自己的成长经历时，总统先生不无感慨地表示：这完全得益于中学时代的一次总统模拟活动。 &lt;span style=\"text-emphasis: none;-webkit-text-emphasis:none;\"&gt;&lt;zmsubline contenteditable=\"false\" answer-str=\"\"&gt;空类2&lt;/zmsubline&gt;&lt;/span&gt;。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "optionList": [</span></span><br><span class="line"><span class="string">        "&lt;p&gt;从小立大志，定能从此走向辉煌 。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;学生时代的生活经历，对人的影响实在重要。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;想把理想变为现实，就一定要经历生活的磨难。&lt;/p&gt;",</span></span><br><span class="line"><span class="string">        "&lt;p&gt;多方面开展模仿活动，对人的成长不无裨益。&lt;/p&gt;"</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "answer": "B",</span></span><br><span class="line"><span class="string">    "analysis": "&lt;p&gt;保持中心统一。即所有的句子都要围绕一个中心，不能出现离群句。 &lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;",</span></span><br><span class="line"><span class="string">    "create_time": 1521971297000,</span></span><br><span class="line"><span class="string">    "gradeId": 1,</span></span><br><span class="line"><span class="string">    "subjectId": 1,</span></span><br><span class="line"><span class="string">    "score": 3,</span></span><br><span class="line"><span class="string">    "knowledgeList": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 1,</span></span><br><span class="line"><span class="string">            "name": "补写衔接文段"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": 2,</span></span><br><span class="line"><span class="string">            "name": "哈哈哈"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>如果只是新增字段，不想把全部内容都写在 body 参数里，可以通过“_update”进行操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_update/1'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "doc":&#123;</span></span><br><span class="line"><span class="string">  	 "phaseId":1</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="删除文档">删除文档</h3><p>如果同一个 id 的文档，删除之后又新增了，那么“_version”字段会自增。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request DELETE <span class="string">'localhost:9200/question/_doc/1'</span></span><br></pre></td></tr></table></figure>
<p>可以看到返回值，已经删除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">    <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">    <span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">    <span class="string">"_version"</span>: 3,</span><br><span class="line">    <span class="string">"result"</span>: <span class="string">"deleted"</span>,</span><br><span class="line">    <span class="string">"_shards"</span>: &#123;</span><br><span class="line">        <span class="string">"total"</span>: 3,</span><br><span class="line">        <span class="string">"successful"</span>: 1,</span><br><span class="line">        <span class="string">"failed"</span>: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"_seq_no"</span>: 2,</span><br><span class="line">    <span class="string">"_primary_term"</span>: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="批量新增">批量新增</h3><p>手动一条一条造数据，比较麻烦。可以通过 json 文件，批量增加。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_bulk'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-binary <span class="string">'@/Users/chenpeng/Desktop/question.json'</span></span><br></pre></td></tr></table></figure>
<p>question.json 文件内容如下，按照这样的格式，多添加些数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"index"</span>:&#123;<span class="string">"_id"</span>:<span class="string">"1"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"title"</span>:<span class="string">"&lt;p&gt;与下面句子衔接最恰当的一项是 （  ）&lt;/p&gt;&lt;p&gt;　　克林顿当选为美国总统，成为举世瞩日的风云人物。当谈及自己的成长经历时，总统先生不无感慨地表示：这完全得益于中学时代的一次总统模拟活动。  &lt;span style=\"text-emphasis: none;-webkit-text-emphasis:none;\"&gt;&lt;zmsubline contenteditable=\"false\" answer-str=\"\"&gt;空类2&lt;/zmsubline&gt;&lt;/span&gt;。&lt;/p&gt;"</span>,<span class="string">"optionList"</span>:[<span class="string">"&lt;p&gt;从小立大志，定能从此走向辉煌 。&lt;/p&gt;"</span>,<span class="string">"&lt;p&gt;学生时代的生活经历，对人的影响实在重要。&lt;/p&gt;"</span>,<span class="string">"&lt;p&gt;想把理想变为现实，就一定要经历生活的磨难。&lt;/p&gt;"</span>,<span class="string">"&lt;p&gt;多方面开展模仿活动，对人的成长不无裨益。&lt;/p&gt;"</span>],<span class="string">"answer"</span>:<span class="string">"B"</span>,<span class="string">"analysis"</span>:<span class="string">"&lt;p&gt;保持中心统一。即</span></span><br><span class="line"><span class="string">所有的句子都要围绕一个中心，不能出现离群句。 &lt;/p&gt;&lt;p&gt;&lt;br/&gt;&lt;/p&gt;"</span>,<span class="string">"createTime"</span>:1521971297000,<span class="string">"gradeId"</span>:1,<span class="string">"subjectId"</span>:1,<span class="string">"score"</span>:3,<span class="string">"knowledgeList"</span>:[&#123;<span class="string">"id"</span>:1,<span class="string">"name"</span>:<span class="string">"补写衔接文段"</span>&#125;,&#123;<span class="string">"id"</span>:2,<span class="string">"name"</span>:<span class="string">"哈哈</span></span><br><span class="line"><span class="string">哈"</span>&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>“_bulk”这个操作可以结合 CRUD 一起操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/_bulk'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;"index":&#123;"_index":"question","_id":1&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"gradeId":1&#125;</span></span><br><span class="line"><span class="string">&#123;"delete":&#123;"_index":"question","_id":2&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"create":&#123;"_index":"question","_id":3&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"gradeId":1&#125;</span></span><br><span class="line"><span class="string">&#123;"update":&#123;"_index":"question","_id":1&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"doc":&#123;"gradeId":2&#125;&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>根据返回结果，可以看到，有些操作是失败，有些是成功。不管成功还是失败，都会有提示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"took"</span>: 41,</span><br><span class="line">    <span class="string">"errors"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"items"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"index"</span>: &#123;</span><br><span class="line">                <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">                <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">                <span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">                <span class="string">"_version"</span>: 4,</span><br><span class="line">                <span class="string">"result"</span>: <span class="string">"updated"</span>,</span><br><span class="line">                <span class="string">"_shards"</span>: &#123;</span><br><span class="line">                    <span class="string">"total"</span>: 3,</span><br><span class="line">                    <span class="string">"successful"</span>: 1,</span><br><span class="line">                    <span class="string">"failed"</span>: 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"_seq_no"</span>: 6,</span><br><span class="line">                <span class="string">"_primary_term"</span>: 1,</span><br><span class="line">                <span class="string">"status"</span>: 200</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"delete"</span>: &#123;</span><br><span class="line">                <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">                <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">                <span class="string">"_id"</span>: <span class="string">"2"</span>,</span><br><span class="line">                <span class="string">"_version"</span>: 1,</span><br><span class="line">                <span class="string">"result"</span>: <span class="string">"not_found"</span>,</span><br><span class="line">                <span class="string">"_shards"</span>: &#123;</span><br><span class="line">                    <span class="string">"total"</span>: 3,</span><br><span class="line">                    <span class="string">"successful"</span>: 1,</span><br><span class="line">                    <span class="string">"failed"</span>: 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"_seq_no"</span>: 7,</span><br><span class="line">                <span class="string">"_primary_term"</span>: 1,</span><br><span class="line">                <span class="string">"status"</span>: 404</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"create"</span>: &#123;</span><br><span class="line">                <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">                <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">                <span class="string">"_id"</span>: <span class="string">"3"</span>,</span><br><span class="line">                <span class="string">"_version"</span>: 1,</span><br><span class="line">                <span class="string">"result"</span>: <span class="string">"created"</span>,</span><br><span class="line">                <span class="string">"_shards"</span>: &#123;</span><br><span class="line">                    <span class="string">"total"</span>: 3,</span><br><span class="line">                    <span class="string">"successful"</span>: 1,</span><br><span class="line">                    <span class="string">"failed"</span>: 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"_seq_no"</span>: 8,</span><br><span class="line">                <span class="string">"_primary_term"</span>: 1,</span><br><span class="line">                <span class="string">"status"</span>: 201</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"update"</span>: &#123;</span><br><span class="line">                <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">                <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">                <span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">                <span class="string">"_version"</span>: 5,</span><br><span class="line">                <span class="string">"result"</span>: <span class="string">"updated"</span>,</span><br><span class="line">                <span class="string">"_shards"</span>: &#123;</span><br><span class="line">                    <span class="string">"total"</span>: 3,</span><br><span class="line">                    <span class="string">"successful"</span>: 1,</span><br><span class="line">                    <span class="string">"failed"</span>: 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"_seq_no"</span>: 9,</span><br><span class="line">                <span class="string">"_primary_term"</span>: 1,</span><br><span class="line">                <span class="string">"status"</span>: 200</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="批量获取">批量获取</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/_mget'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "docs": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "_index": "question",</span></span><br><span class="line"><span class="string">            "_id": 1</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "_index": "exam_paper",</span></span><br><span class="line"><span class="string">            "_id": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>返回信息可以看到，没查到的数据，会有提示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"docs"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"_index"</span>: <span class="string">"question"</span>,</span><br><span class="line">            <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">            <span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="string">"_version"</span>: 5,</span><br><span class="line">            <span class="string">"_seq_no"</span>: 9,</span><br><span class="line">            <span class="string">"_primary_term"</span>: 1,</span><br><span class="line">            <span class="string">"found"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="string">"_source"</span>: &#123;</span><br><span class="line">                <span class="string">"grade_id"</span>: 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"_index"</span>: <span class="string">"exam_paper"</span>,</span><br><span class="line">            <span class="string">"_type"</span>: null,</span><br><span class="line">            <span class="string">"_id"</span>: <span class="string">"1"</span>,</span><br><span class="line">            <span class="string">"error"</span>: &#123;</span><br><span class="line">                <span class="string">"root_cause"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"type"</span>: <span class="string">"index_not_found_exception"</span>,</span><br><span class="line">                        <span class="string">"reason"</span>: <span class="string">"no such index [exam_paper]"</span>,</span><br><span class="line">                        <span class="string">"resource.type"</span>: <span class="string">"index_expression"</span>,</span><br><span class="line">                        <span class="string">"resource.id"</span>: <span class="string">"exam_paper"</span>,</span><br><span class="line">                        <span class="string">"index_uuid"</span>: <span class="string">"_na_"</span>,</span><br><span class="line">                        <span class="string">"index"</span>: <span class="string">"exam_paper"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">"type"</span>: <span class="string">"index_not_found_exception"</span>,</span><br><span class="line">                <span class="string">"reason"</span>: <span class="string">"no such index [exam_paper]"</span>,</span><br><span class="line">                <span class="string">"resource.type"</span>: <span class="string">"index_expression"</span>,</span><br><span class="line">                <span class="string">"resource.id"</span>: <span class="string">"exam_paper"</span>,</span><br><span class="line">                <span class="string">"index_uuid"</span>: <span class="string">"_na_"</span>,</span><br><span class="line">                <span class="string">"index"</span>: <span class="string">"exam_paper"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="批量查询">批量查询</h3><p>和批量获取一个套路。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/_msearch'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;"index":"question"&#125;</span></span><br><span class="line"><span class="string">&#123;"query":&#123;"term":&#123;"grade_id":1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">&#123;"index":"exam_paper"&#125;</span></span><br><span class="line"><span class="string">&#123;"query":&#123;"term":&#123;"grade_id":1&#125;&#125;&#125;</span></span><br><span class="line"><span class="string">'</span></span><br></pre></td></tr></table></figure>
<h2 id="搜索">搜索</h2><h3 id="衡量相关性">衡量相关性</h3><p>1.查准率（precision），尽可能返回较少的无关文档。 2.查全率（recall），尽量返回较多的相关文档。 3.排序（ranking），按照相关度进行排序。</p>
<h3 id="URI_Search">URI Search</h3><p>在 URL 参数中添加查询参数，比如查询 gradeId=1 的数据。这种也就查询参数少，可以用一下，多了要疯。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search?q=gradeId:1'</span></span><br></pre></td></tr></table></figure>
<h3 id="Request_Body_Search">Request Body Search</h3><p>GET 或者 POST 都可以。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="match">match</h4><p>目前业务中，使用的是这个 match，配合 minimum_should_match。然后分词还是用的 ik_smart，效果贼差，天天被业务骂。可以加上“operator”参数，设置为“AND”，这样就查询“中国”两个字连在一起的文档。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "title": &#123;</span></span><br><span class="line"><span class="string">                "query": "中国",</span></span><br><span class="line"><span class="string">                "minimum_should_match": "80%"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="match_phrase">match_phrase</h4><p>网传最常用的查询用词，配合 slop 使用。slop 的值大概就是允许查询的词中间间隔的距离。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "bool": &#123;</span></span><br><span class="line"><span class="string">            "should": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match_phrase": &#123;</span></span><br><span class="line"><span class="string">                        "title": &#123;</span></span><br><span class="line"><span class="string">                            "query": "衔最",</span></span><br><span class="line"><span class="string">                            "slop": 1</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match_phrase": &#123;</span></span><br><span class="line"><span class="string">                        "title.standard": &#123;</span></span><br><span class="line"><span class="string">                            "query": "衔最",</span></span><br><span class="line"><span class="string">                            "slop": 1</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="term">term</h4><p>不分词，严格匹配，完全一样才行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">        	"gradeId":1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="terms">terms</h4><p>匹配多个数值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">        	"gradeId":[1,2]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="filter">filter</h4><p>配合 constant_score 不打分，很快返回数据，有效利用缓存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "constant_score": &#123;</span></span><br><span class="line"><span class="string">            "filter": &#123;</span></span><br><span class="line"><span class="string">                "term": &#123;</span></span><br><span class="line"><span class="string">                    "gradeId": 1</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="range">range</h4><p>范围查询，大于等于，小于之类的。比如查询 1 年级到 9 年级的数据，不包括 9 年级。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "constant_score": &#123;</span></span><br><span class="line"><span class="string">            "filter": &#123;</span></span><br><span class="line"><span class="string">                "range": &#123;</span></span><br><span class="line"><span class="string">                    "gradeId": &#123;</span></span><br><span class="line"><span class="string">                        "gte": 1,</span></span><br><span class="line"><span class="string">                        "lt": 9</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="explain">explain</h4><p>可以看到算分的过程。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "explain": true,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "title": "鸟语花香"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="bool,must,should，must_not">bool,must,should，must_not</h4><p>包含多个查询时，需要用到 bool。<br>should 是 or 的关系，must 和 must_not 是 and 的关系。</p>
<h4 id="boost">boost</h4><p>可以用来提交权重。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "explain": true,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "bool": &#123;</span></span><br><span class="line"><span class="string">            "should": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match": &#123;</span></span><br><span class="line"><span class="string">                        "title": &#123;</span></span><br><span class="line"><span class="string">                            "query": "鸟语花香",</span></span><br><span class="line"><span class="string">                            "boost": 2</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match": &#123;</span></span><br><span class="line"><span class="string">                        "optionList": &#123;</span></span><br><span class="line"><span class="string">                            "query": "鸟语花香",</span></span><br><span class="line"><span class="string">                            "boost": 1</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="boosting">boosting</h4><p>当我查“鸟语”这个词的时候，希望带“花香”这个词的结果靠后些。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "boosting": &#123;</span></span><br><span class="line"><span class="string">            "positive": &#123;</span></span><br><span class="line"><span class="string">                "match": &#123;</span></span><br><span class="line"><span class="string">                    "title": &#123;</span></span><br><span class="line"><span class="string">                        "query": "鸟语"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "negative": &#123;</span></span><br><span class="line"><span class="string">                "match": &#123;</span></span><br><span class="line"><span class="string">                    "title": &#123;</span></span><br><span class="line"><span class="string">                        "query": "花香"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "negative_boost": 0.2</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="profile">profile</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "profile": true,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "gradeId": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="分页（from,size）">分页（from,size）</h4><p>from 和 size，可想而知，性能比较差。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "gradeId": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "from": 0,</span></span><br><span class="line"><span class="string">    "size": 20</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="深度分页（search_after）">深度分页（search_after）</h4><p>优化深度分页之 search_after。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "sort": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "gradeId": &#123;</span></span><br><span class="line"><span class="string">                "order": "desc"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": "desc"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>返回值中有个 sort 对象，比如是“[16,123456]”，将这个 sort 的值，放在 search_after 中，实现分页。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "search_after": [</span></span><br><span class="line"><span class="string">        16,</span></span><br><span class="line"><span class="string">        123456</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "sort": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "gradeId": &#123;</span></span><br><span class="line"><span class="string">                "order": "desc"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": "desc"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="深度分页(scroll)">深度分页(scroll)</h4><p>scroll 可以设置快照，每次查询输入上一次的 scroll id。缺点就是新写入的数据查不到。通过下面的语句，生成一个 5 分钟的快照。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search?scroll=5m'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "size": 1,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match_all": &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>将返回的_scroll_id 作为参数，再次查询。注：url 上不用加索引名。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/_search?scroll'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "scroll": "1m",</span></span><br><span class="line"><span class="string">    "scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAADL0OQFm5ScElGSHlzU3ZTLTUtSGp0UWNzN1EAAAAAAp29nxZKN1NyM0ZnTVJseU1BblY0T2RQaXFBAAAAAAKmQBoWRnZleHZwazlRWU9sWEF1bEtXRk94UQAAAAACpkAbFkZ2ZXh2cGs5UVlPbFhBdWxLV0ZPeFEAAAAAAp29oBZKN1NyM0ZnTVJseU1BblY0T2RQaXFB"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="_source">_source</h4><p>如果不需要返回全部字段，可以通过设置_source 字段，返回需要的字段。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "_source": [</span></span><br><span class="line"><span class="string">        "title",</span></span><br><span class="line"><span class="string">        "optionList"</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "gradeId": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="sort">sort</h4><p>排序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "gradeId": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "sort": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "gradeId": "desc"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "id": "desc"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="script_field">script_field</h4><p>有时候需要返回自定义数据，比如把年级和学科合并成一个字段返回。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "script_fields": &#123;</span></span><br><span class="line"><span class="string">        "grade_subject": &#123;</span></span><br><span class="line"><span class="string">            "script": &#123;</span></span><br><span class="line"><span class="string">                "lang": "painless",</span></span><br><span class="line"><span class="string">                "source": "doc['</span>\<span class="string">''</span>gradeId<span class="string">'\'</span><span class="string">'].value + '</span>\<span class="string">''</span>-<span class="string">'\'</span><span class="string">' + doc['</span>\<span class="string">''</span>subjectId<span class="string">'\'</span><span class="string">'].value"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "term": &#123;</span></span><br><span class="line"><span class="string">            "gradeId": 1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="query_string">query_string</h4><p>还有个 simple_query_string，去掉了复杂操作，默认情况下，像下面语句的“AND”会当成普通字符处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "query_string": &#123;</span></span><br><span class="line"><span class="string">            "fields": [</span></span><br><span class="line"><span class="string">                "title",</span></span><br><span class="line"><span class="string">                "optionList"</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            "query": "(美 AND 女) OR (帅 AND 哥)"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="聚合（aggregation）">聚合（aggregation）</h4><p><img src="https://cdn.nlark.com/yuque/0/2020/png/592189/1592450646659-be4423d7-1c38-4313-8c85-29db8ea05cf3.png#align=left&amp;display=inline&amp;height=285&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=570&amp;originWidth=1192&amp;size=140385&amp;status=done&amp;style=none&amp;width=596" alt="image.png"><br>比如查询每个年级下，有多少道题目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "size":0,</span></span><br><span class="line"><span class="string">  "aggs": &#123;</span></span><br><span class="line"><span class="string">    "grade_count": &#123;</span></span><br><span class="line"><span class="string">      "terms": &#123;</span></span><br><span class="line"><span class="string">        "field":"gradeId"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>返回值可以看到一个叫做“buckets”的参数。“key”就是年级 id，“doc_count”就是文档的数量（即题目的数量）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 1035,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 5,</span><br><span class="line">    <span class="string">"successful"</span> : 5,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 10000,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"gte"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max_score"</span> : null,</span><br><span class="line">    <span class="string">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"aggregations"</span> : &#123;</span><br><span class="line">    <span class="string">"grade_count"</span> : &#123;</span><br><span class="line">      <span class="string">"doc_count_error_upper_bound"</span> : 0,</span><br><span class="line">      <span class="string">"sum_other_doc_count"</span> : 47364,</span><br><span class="line">      <span class="string">"buckets"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 9,</span><br><span class="line">          <span class="string">"doc_count"</span> : 713194</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 11,</span><br><span class="line">          <span class="string">"doc_count"</span> : 673674</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 10,</span><br><span class="line">          <span class="string">"doc_count"</span> : 670363</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 12,</span><br><span class="line">          <span class="string">"doc_count"</span> : 601702</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 8,</span><br><span class="line">          <span class="string">"doc_count"</span> : 458388</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 7,</span><br><span class="line">          <span class="string">"doc_count"</span> : 397209</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 6,</span><br><span class="line">          <span class="string">"doc_count"</span> : 118732</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 4,</span><br><span class="line">          <span class="string">"doc_count"</span> : 98695</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 5,</span><br><span class="line">          <span class="string">"doc_count"</span> : 96475</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 3,</span><br><span class="line">          <span class="string">"doc_count"</span> : 62352</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再比如，嵌套查询。每个年级下，有多少道题目，以及平均分值、最大分值、最小分值。<br>还有 range 之类的就不谈了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "size": 0,</span></span><br><span class="line"><span class="string">    "aggs": &#123;</span></span><br><span class="line"><span class="string">        "grade_count": &#123;</span></span><br><span class="line"><span class="string">            "terms": &#123;</span></span><br><span class="line"><span class="string">                "size": 20,</span></span><br><span class="line"><span class="string">                "field": "gradeId",</span></span><br><span class="line"><span class="string">                "order": &#123;</span></span><br><span class="line"><span class="string">                    "_count": "asc"</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "aggs": &#123;</span></span><br><span class="line"><span class="string">                "avg_score": &#123;</span></span><br><span class="line"><span class="string">                    "avg": &#123;</span></span><br><span class="line"><span class="string">                        "field": "score"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "max_score": &#123;</span></span><br><span class="line"><span class="string">                    "max": &#123;</span></span><br><span class="line"><span class="string">                        "field": "score"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "min_score": &#123;</span></span><br><span class="line"><span class="string">                    "min": &#123;</span></span><br><span class="line"><span class="string">                        "field": "score"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>查看返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 184,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 5,</span><br><span class="line">    <span class="string">"successful"</span> : 5,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 10000,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"gte"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max_score"</span> : null,</span><br><span class="line">    <span class="string">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"aggregations"</span> : &#123;</span><br><span class="line">    <span class="string">"grade_count"</span> : &#123;</span><br><span class="line">      <span class="string">"doc_count_error_upper_bound"</span> : 0,</span><br><span class="line">      <span class="string">"sum_other_doc_count"</span> : 0,</span><br><span class="line">      <span class="string">"buckets"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 15,</span><br><span class="line">          <span class="string">"doc_count"</span> : 2142,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 84.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 4.774276377217554</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 16,</span><br><span class="line">          <span class="string">"doc_count"</span> : 3269,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 9.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.0541449984704805</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 13,</span><br><span class="line">          <span class="string">"doc_count"</span> : 4834,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 20.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.1849193213939864</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 14,</span><br><span class="line">          <span class="string">"doc_count"</span> : 5633,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 100.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.850062133786354</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 1,</span><br><span class="line">          <span class="string">"doc_count"</span> : 15003,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 60.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.181730320475415</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 2,</span><br><span class="line">          <span class="string">"doc_count"</span> : 16619,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 149.5</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.219586015959869</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 3,</span><br><span class="line">          <span class="string">"doc_count"</span> : 62397,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 120.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.3595942918472184</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 5,</span><br><span class="line">          <span class="string">"doc_count"</span> : 96676,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 135.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.4549805536022142</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 4,</span><br><span class="line">          <span class="string">"doc_count"</span> : 99141,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 60.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.483098379566984</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 6,</span><br><span class="line">          <span class="string">"doc_count"</span> : 118872,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 100.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.4849182313753255</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 7,</span><br><span class="line">          <span class="string">"doc_count"</span> : 397801,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 99.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.5365455103852628</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 8,</span><br><span class="line">          <span class="string">"doc_count"</span> : 459159,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 99.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.5656048361046837</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 12,</span><br><span class="line">          <span class="string">"doc_count"</span> : 602704,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 100.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 4.161399764440374</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 10,</span><br><span class="line">          <span class="string">"doc_count"</span> : 671880,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 95.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.815223081977252</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 11,</span><br><span class="line">          <span class="string">"doc_count"</span> : 675079,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 99.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.8290252659518145</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"key"</span> : 9,</span><br><span class="line">          <span class="string">"doc_count"</span> : 714447,</span><br><span class="line">          <span class="string">"max_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 100.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"min_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 0.0</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">"avg_score"</span> : &#123;</span><br><span class="line">            <span class="string">"value"</span> : 3.6762113918055883</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以把最大值最小值平均值求和之类的一起查出来。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "size": 0,</span></span><br><span class="line"><span class="string">    "aggs": &#123;</span></span><br><span class="line"><span class="string">        "stats_score": &#123;</span></span><br><span class="line"><span class="string">            "stats": &#123;</span></span><br><span class="line"><span class="string">                "field": "score"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>查看返回值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 1105,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 5,</span><br><span class="line">    <span class="string">"successful"</span> : 5,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 10000,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"gte"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max_score"</span> : null,</span><br><span class="line">    <span class="string">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"aggregations"</span> : &#123;</span><br><span class="line">    <span class="string">"stats_score"</span> : &#123;</span><br><span class="line">      <span class="string">"count"</span> : 3946525,</span><br><span class="line">      <span class="string">"min"</span> : 0.0,</span><br><span class="line">      <span class="string">"max"</span> : 149.5,</span><br><span class="line">      <span class="string">"avg"</span> : 3.746341773761074,</span><br><span class="line">      <span class="string">"sum"</span> : 1.4785031468692422E7</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多值">多值</h4><p>一个字段，在文档中，有些数据是单值，有些是多值，这个时候要精确匹配比较麻烦。<br>比如一个题目可以有一个知识点，也可以有多个知识点。那么有这样一个需求，“精确查询有理数这个知识点下的题目，如果题目包含了其他知识点就不要。”。对于这种需求，我们可以增加一个字段，knowledgeCount 记录知识点个数。可以达到精确匹配的目的。</p>
<h4 id="dis_max">dis_max</h4><p>单字符串多字段查询的时候，会用 should，但是 should 打分计算方式返回的结果，可能不符合预期。这个时候就需要引入 dis max query 了。有个 tie_breaker 参数可以用一下，这个参数默认为 0，最大值为 1。使用它，主要是为了增加其他字段起的作用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "dis_max": &#123;</span></span><br><span class="line"><span class="string">            "queries": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match": &#123;</span></span><br><span class="line"><span class="string">                        "title": "鸟语花香"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match": &#123;</span></span><br><span class="line"><span class="string">                        "optionList": "鸟语花香"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            "tie_breaker": 0.1</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="multi_match">multi_match</h4><p>另一个用来查单字符串多字段的用法。type 有 best_fields，most_fields，cross_fields（最佳字段、多数字段、跨字段）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "multi_match": &#123;</span></span><br><span class="line"><span class="string">            "type": "best_fields",</span></span><br><span class="line"><span class="string">            "query": "鸟语花香",</span></span><br><span class="line"><span class="string">            "fields": [</span></span><br><span class="line"><span class="string">                "title",</span></span><br><span class="line"><span class="string">                "optionList"</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            "tie_breaker": 0.2,</span></span><br><span class="line"><span class="string">            "minimum_should_match": "20%"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="search_template">search_template</h4><p>新建一个 search_template。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/_scripts/question_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "script": &#123;</span></span><br><span class="line"><span class="string">        "lang": "mustache",</span></span><br><span class="line"><span class="string">        "source": &#123;</span></span><br><span class="line"><span class="string">            "_source": [</span></span><br><span class="line"><span class="string">                "title",</span></span><br><span class="line"><span class="string">                "optionList"</span></span><br><span class="line"><span class="string">            ],</span></span><br><span class="line"><span class="string">            "size": 20,</span></span><br><span class="line"><span class="string">            "query": &#123;</span></span><br><span class="line"><span class="string">                "multi_match": &#123;</span></span><br><span class="line"><span class="string">                    "query": "&#123;&#123;q&#125;&#125;",</span></span><br><span class="line"><span class="string">                    "fields": [</span></span><br><span class="line"><span class="string">                        "title",</span></span><br><span class="line"><span class="string">                        "optionList"</span></span><br><span class="line"><span class="string">                    ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>通过 search_template 执行查询语句。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search/template'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "id": "question_search",</span></span><br><span class="line"><span class="string">    "params": &#123;</span></span><br><span class="line"><span class="string">        "q": "鸟语花香"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="function_score_query">function score query</h4><p>有时候 es 打分生成的排序，不一定满足我们的需求。比如我希望随机符合查询条件的数据，就可以用 random score。seed 可以设置为 userId，不同的人可以查到不同的随机数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "from": 0,</span></span><br><span class="line"><span class="string">    "size": 20,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "function_score": &#123;</span></span><br><span class="line"><span class="string">            "query": &#123;</span></span><br><span class="line"><span class="string">                "bool": &#123;</span></span><br><span class="line"><span class="string">                    "filter": &#123;</span></span><br><span class="line"><span class="string">                        "bool": &#123;</span></span><br><span class="line"><span class="string">                            "must": [</span></span><br><span class="line"><span class="string">                                &#123;</span></span><br><span class="line"><span class="string">                                    "term": &#123;</span></span><br><span class="line"><span class="string">                                        "gradeId": 1</span></span><br><span class="line"><span class="string">                                    &#125;</span></span><br><span class="line"><span class="string">                                &#125;,</span></span><br><span class="line"><span class="string">                                &#123;</span></span><br><span class="line"><span class="string">                                    "terms": &#123;</span></span><br><span class="line"><span class="string">                                        "subjectId": [</span></span><br><span class="line"><span class="string">                                            1,</span></span><br><span class="line"><span class="string">                                            2,</span></span><br><span class="line"><span class="string">                                            3,</span></span><br><span class="line"><span class="string">                                            4</span></span><br><span class="line"><span class="string">                                        ]</span></span><br><span class="line"><span class="string">                                    &#125;</span></span><br><span class="line"><span class="string">                                &#125;</span></span><br><span class="line"><span class="string">                            ]</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "functions": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "random_score": &#123;</span></span><br><span class="line"><span class="string">                        "seed": 123</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="suggester">suggester</h4><p>特殊类型的搜索。比如输入了一个错误的词汇“helo”。suggest_mode 有 missing（如果索引中已经存在，就不提供建议。），popular（推荐出现频率更加高的词），always（无论是否存在，都提供建议）。<br>除了 term-suggestion，还有 phrase-suggestion。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "size": 1,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "title": "helo"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "suggest": &#123;</span></span><br><span class="line"><span class="string">        "term-suggestion": &#123;</span></span><br><span class="line"><span class="string">            "text": "helo",</span></span><br><span class="line"><span class="string">            "term": &#123;</span></span><br><span class="line"><span class="string">                "suggest_mode": "missing",</span></span><br><span class="line"><span class="string">                "field": "title"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>es 返回的 suggest 中，告知我们“hello”，还有几个可选项。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 606,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 5,</span><br><span class="line">    <span class="string">"successful"</span> : 5,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 0,</span><br><span class="line">      <span class="string">"relation"</span> : <span class="string">"eq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max_score"</span> : null,</span><br><span class="line">    <span class="string">"hits"</span> : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"suggest"</span> : &#123;</span><br><span class="line">    <span class="string">"term-suggestion"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"text"</span> : <span class="string">"helo"</span>,</span><br><span class="line">        <span class="string">"offset"</span> : 0,</span><br><span class="line">        <span class="string">"length"</span> : 4,</span><br><span class="line">        <span class="string">"options"</span> : [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"help"</span>,</span><br><span class="line">            <span class="string">"score"</span> : 0.75,</span><br><span class="line">            <span class="string">"freq"</span> : 64793</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"held"</span>,</span><br><span class="line">            <span class="string">"score"</span> : 0.75,</span><br><span class="line">            <span class="string">"freq"</span> : 8172</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"hello"</span>,</span><br><span class="line">            <span class="string">"score"</span> : 0.75,</span><br><span class="line">            <span class="string">"freq"</span> : 7261</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"hero"</span>,</span><br><span class="line">            <span class="string">"score"</span> : 0.75,</span><br><span class="line">            <span class="string">"freq"</span> : 1687</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"hclo"</span>,</span><br><span class="line">            <span class="string">"score"</span> : 0.75,</span><br><span class="line">            <span class="string">"freq"</span> : 1065</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="completion_suggester">completion suggester</h4><p>自动补全功能，这玩意对性能要求挺高，es 将 analyze 的数据编码成 FST，和索引一起存放，并且 FST 整个加载到内存。FST 只能用于前缀查找。Finite State Transducers（有限状态传感器）。<br>需要建立索引的时候，将字段的 type 设置为 completion。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "size":0,</span></span><br><span class="line"><span class="string">  "suggest": &#123;</span></span><br><span class="line"><span class="string">    "title-suggester": &#123;</span></span><br><span class="line"><span class="string">      "prefix": "h",</span></span><br><span class="line"><span class="string">      "completion": &#123;</span></span><br><span class="line"><span class="string">        "field": "title"</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h4 id="高亮">高亮</h4><p>默认高亮使用<em></em>包裹关键词，可以用 pre_tags 和 post_tags 参数替换。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">'localhost:9200/question/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "match": &#123;</span></span><br><span class="line"><span class="string">            "title": "语文"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "highlight": &#123;</span></span><br><span class="line"><span class="string">        "pre_tags": "&lt;h1&gt;",</span></span><br><span class="line"><span class="string">        "post_tags": "&lt;/h1&gt;",</span></span><br><span class="line"><span class="string">        "fields": &#123;</span></span><br><span class="line"><span class="string">            "title": &#123;&#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="动态词库">动态词库</h2><p>ik 分词可以设置动态的词库，满足特定的需求。比如根据业务的特性，有些词不需要分词。<br>在目录/Users/chenpeng/Desktop/elasticsearch-7.7.1/config/analysis-ik 下可以看到一份名为 IKAnalyzer.cfg.xml 的文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM <span class="string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key=<span class="string">"ext_dict"</span>&gt;&lt;/entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key=<span class="string">"ext_stopwords"</span>&gt;&lt;/entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=<span class="string">"remote_ext_dict"</span>&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=<span class="string">"remote_ext_stopwords"</span>&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
<p>方便起见，自然是搞个远程扩展字典。重启服务生效，当然对于已经存在的索引，需要重建索引。</p>
<h2 id="重建索引">重建索引</h2><h3 id="update_by_query">update by query</h3><p>现有索引上进行重建。比如把 gradeId=1 的数据 gradeId 改成 2。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question/_update_by_query'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "script": &#123;</span></span><br><span class="line"><span class="string">        "source": "ctx._source['</span>\<span class="string">''</span>gradeId<span class="string">'\'</span><span class="string">']=2"</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "bool": &#123;</span></span><br><span class="line"><span class="string">            "must": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "exists": &#123;</span></span><br><span class="line"><span class="string">                        "field": "gradeId"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "term": &#123;</span></span><br><span class="line"><span class="string">                        "gradeId": 1</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="reindex">reindex</h3><p>有时候要改字段格式，或者更换分词插件，这个时候就需要将整个索引重新刷新一遍。es 提供了 reindex，可以自动重建索引。比如，新建了索引 question_v2，将原索引 question_v1 数据重新导入 question_v2。<br>数据量比较大的话，要等好久。可以异步处理，url 后面加上 wait_for_completion=false，会返回一个 task id。根据这个 task id 可以随时查看进度。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'http://localhost:9200/_reindex'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "source": &#123;</span></span><br><span class="line"><span class="string">    "index": "question_v1"</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  "dest": &#123;</span></span><br><span class="line"><span class="string">    "index": "question_v2"</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="别名">别名</h3><p>结合别名，可以方便管理不同版本的索引。比如之前 question_v1 的别名是 question，reindex 完毕，将 question_v2 别名设置为 question，再将 question_v1 的别名去掉。那么所有的 question 索引 CRUD 都会转移到 question_v2 上。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/_aliases'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "actions": [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "remove": &#123;</span></span><br><span class="line"><span class="string">                "index": "question_v1",</span></span><br><span class="line"><span class="string">                "alias": "question"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            "add": &#123;</span></span><br><span class="line"><span class="string">                "index": "question_v2",</span></span><br><span class="line"><span class="string">                "alias": "question"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="数据建模">数据建模</h2><p>在我们的需求中，题目 id 和知识点 id 有关联关系。同时为了整个业务的性能，也需要存在知识点的名称。</p>
<h3 id="nested_data_type">nested data type</h3><p>目前知识点是以[{“id”:1,”name”:”有理数”},{“id”:2,”name”:”公式”}]，这种形式存储的。如果我同时搜 id=1 and name=公式，是可以搜出来，这个就有问题了。为了解决这个问题，引入了 nested 数据类型。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request PUT <span class="string">'localhost:9200/question_v1'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "mappings": &#123;</span></span><br><span class="line"><span class="string">        "_source": &#123;</span></span><br><span class="line"><span class="string">            "enabled": false</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "properties": &#123;</span></span><br><span class="line"><span class="string">            "analysis": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "answer": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "createTime": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "gradeId": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "id": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "knowledgeList": &#123;</span></span><br><span class="line"><span class="string">                "type": "nested",</span></span><br><span class="line"><span class="string">                "properties": &#123;</span></span><br><span class="line"><span class="string">                    "id": &#123;</span></span><br><span class="line"><span class="string">                        "type": "long",</span></span><br><span class="line"><span class="string">                        "copy_to": "knowledgeIdList"</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "name": &#123;</span></span><br><span class="line"><span class="string">                        "type": "keyword"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "mainKnowledge": &#123;</span></span><br><span class="line"><span class="string">            	 "type": "nested",</span></span><br><span class="line"><span class="string">                "properties": &#123;</span></span><br><span class="line"><span class="string">                    "id": &#123;</span></span><br><span class="line"><span class="string">                        "type": "long",</span></span><br><span class="line"><span class="string">                        "copy_to": "knowledgeIdList"</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "name": &#123;</span></span><br><span class="line"><span class="string">                        "type": "keyword"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "optionList": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "score": &#123;</span></span><br><span class="line"><span class="string">                "type": "float"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "subjectId": &#123;</span></span><br><span class="line"><span class="string">                "type": "long"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            "title": &#123;</span></span><br><span class="line"><span class="string">                "type": "text",</span></span><br><span class="line"><span class="string">                "fields": &#123;</span></span><br><span class="line"><span class="string">                    "keyword": &#123;</span></span><br><span class="line"><span class="string">                        "type": "keyword",</span></span><br><span class="line"><span class="string">                        "ignore_above": 256</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    "standard": &#123;</span></span><br><span class="line"><span class="string">                        "type": "text",</span></span><br><span class="line"><span class="string">                        "analyzer": "standard"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                "analyzer": "ik_max_word"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "settings": &#123;</span></span><br><span class="line"><span class="string">        "number_of_shards": "1",</span></span><br><span class="line"><span class="string">        "number_of_replicas": "2"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p>查询的时候，需要使用 nested 关键字，指定 path。当然，聚合查询的时候，也一样要加 nested 关键字，指定 path。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request POST <span class="string">'localhost:9200/question_v1/_search'</span> \</span><br><span class="line">--header <span class="string">'Content-Type: application/json'</span> \</span><br><span class="line">--data-raw <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "query": &#123;</span></span><br><span class="line"><span class="string">        "bool": &#123;</span></span><br><span class="line"><span class="string">            "must": [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "match": &#123;</span></span><br><span class="line"><span class="string">                        "title": "有理数"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                    "nested": &#123;</span></span><br><span class="line"><span class="string">                        "path": "knowledgeList",</span></span><br><span class="line"><span class="string">                        "query": &#123;</span></span><br><span class="line"><span class="string">                            "bool": &#123;</span></span><br><span class="line"><span class="string">                                "must": [</span></span><br><span class="line"><span class="string">                                    &#123;</span></span><br><span class="line"><span class="string">                                        "term": &#123;</span></span><br><span class="line"><span class="string">                                            "knowledgeDocList.id": 1</span></span><br><span class="line"><span class="string">                                        &#125;</span></span><br><span class="line"><span class="string">                                    &#125;,</span></span><br><span class="line"><span class="string">                                    &#123;</span></span><br><span class="line"><span class="string">                                        "term": &#123;</span></span><br><span class="line"><span class="string">                                            "knowledgeDocList.name": "公式"</span></span><br><span class="line"><span class="string">                                        &#125;</span></span><br><span class="line"><span class="string">                                    &#125;</span></span><br><span class="line"><span class="string">                                ]</span></span><br><span class="line"><span class="string">                            &#125;</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="父子文档">父子文档</h3><p>有种题目叫复合题，比如英语完形填空。大题是一段题干，子题是多个小题。大题和子题结构相似，这种可以搞个父子文档。不过，其实这种情况不是很适合用父子文档结构，博客和评论的存储更合适（评论经常单独更新）。</p>
<h3 id="script">script</h3><p>es 自带的查询可能不满足我们的需求，于是提供了 painless 脚本，让我们自己玩。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">


</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://chenpeng.github.io/2020/06/11/yuque/Elasticsearch笔记/" data-title="Elasticsearch笔记 | 养只阿柴捏脸玩" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2020/07/02/yuque/网络协议笔记/" title="网络协议笔记">
  <strong>上一篇：</strong><br/>
  <span>
  网络协议笔记</span>
</a>
</div>


<div class="next">
<a href="/2020/03/05/yuque/Flutter笔记/"  title="Flutter笔记">
 <strong>下一篇：</strong><br/> 
 <span>Flutter笔记
</span>
</a>
</div>

</nav>

	



</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用的场景"><span class="toc-number">1.1.</span> <span class="toc-text">使用的场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务不满意"><span class="toc-number">1.2.</span> <span class="toc-text">业务不满意</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#技术实现"><span class="toc-number">2.</span> <span class="toc-text">技术实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备"><span class="toc-number">2.1.</span> <span class="toc-text">准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">2.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#集群"><span class="toc-number">2.1.2.</span> <span class="toc-text">集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件"><span class="toc-number">2.1.3.</span> <span class="toc-text">插件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试分词"><span class="toc-number">2.1.4.</span> <span class="toc-text">测试分词</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分析器"><span class="toc-number">2.2.</span> <span class="toc-text">分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#character_filters"><span class="toc-number">2.2.1.</span> <span class="toc-text">character filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tokenizers"><span class="toc-number">2.2.2.</span> <span class="toc-text">tokenizers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#token_filters"><span class="toc-number">2.2.3.</span> <span class="toc-text">token filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义"><span class="toc-number">2.2.4.</span> <span class="toc-text">自定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引"><span class="toc-number">2.3.</span> <span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新建索引"><span class="toc-number">2.3.1.</span> <span class="toc-text">新建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询索引"><span class="toc-number">2.3.2.</span> <span class="toc-text">查询索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除索引"><span class="toc-number">2.3.3.</span> <span class="toc-text">删除索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#映射（mapping）"><span class="toc-number">2.3.4.</span> <span class="toc-text">映射（mapping）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#copy_to"><span class="toc-number">2.3.5.</span> <span class="toc-text">copy_to</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态映射（dynamic_mapping）"><span class="toc-number">2.3.6.</span> <span class="toc-text">动态映射（dynamic mapping）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置（_settings）"><span class="toc-number">2.3.7.</span> <span class="toc-text">设置（_settings）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#模版（_template）"><span class="toc-number">2.4.</span> <span class="toc-text">模版（_template）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建模版"><span class="toc-number">2.4.1.</span> <span class="toc-text">创建模版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询模版"><span class="toc-number">2.4.2.</span> <span class="toc-text">查询模版</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用模版"><span class="toc-number">2.4.3.</span> <span class="toc-text">使用模版</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#文档_CRUD"><span class="toc-number">2.5.</span> <span class="toc-text">文档 CRUD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#新增文档"><span class="toc-number">2.5.1.</span> <span class="toc-text">新增文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看文档"><span class="toc-number">2.5.2.</span> <span class="toc-text">查看文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新文档"><span class="toc-number">2.5.3.</span> <span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除文档"><span class="toc-number">2.5.4.</span> <span class="toc-text">删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量新增"><span class="toc-number">2.5.5.</span> <span class="toc-text">批量新增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量获取"><span class="toc-number">2.5.6.</span> <span class="toc-text">批量获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量查询"><span class="toc-number">2.5.7.</span> <span class="toc-text">批量查询</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#搜索"><span class="toc-number">2.6.</span> <span class="toc-text">搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#衡量相关性"><span class="toc-number">2.6.1.</span> <span class="toc-text">衡量相关性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#URI_Search"><span class="toc-number">2.6.2.</span> <span class="toc-text">URI Search</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Request_Body_Search"><span class="toc-number">2.6.3.</span> <span class="toc-text">Request Body Search</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#match"><span class="toc-number">2.6.3.1.</span> <span class="toc-text">match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match_phrase"><span class="toc-number">2.6.3.2.</span> <span class="toc-text">match_phrase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#term"><span class="toc-number">2.6.3.3.</span> <span class="toc-text">term</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#terms"><span class="toc-number">2.6.3.4.</span> <span class="toc-text">terms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#filter"><span class="toc-number">2.6.3.5.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#range"><span class="toc-number">2.6.3.6.</span> <span class="toc-text">range</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#explain"><span class="toc-number">2.6.3.7.</span> <span class="toc-text">explain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bool,must,should，must_not"><span class="toc-number">2.6.3.8.</span> <span class="toc-text">bool,must,should，must_not</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boost"><span class="toc-number">2.6.3.9.</span> <span class="toc-text">boost</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#boosting"><span class="toc-number">2.6.3.10.</span> <span class="toc-text">boosting</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#profile"><span class="toc-number">2.6.3.11.</span> <span class="toc-text">profile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分页（from,size）"><span class="toc-number">2.6.3.12.</span> <span class="toc-text">分页（from,size）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#深度分页（search_after）"><span class="toc-number">2.6.3.13.</span> <span class="toc-text">深度分页（search_after）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#深度分页(scroll)"><span class="toc-number">2.6.3.14.</span> <span class="toc-text">深度分页(scroll)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#_source"><span class="toc-number">2.6.3.15.</span> <span class="toc-text">_source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sort"><span class="toc-number">2.6.3.16.</span> <span class="toc-text">sort</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#script_field"><span class="toc-number">2.6.3.17.</span> <span class="toc-text">script_field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#query_string"><span class="toc-number">2.6.3.18.</span> <span class="toc-text">query_string</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#聚合（aggregation）"><span class="toc-number">2.6.3.19.</span> <span class="toc-text">聚合（aggregation）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多值"><span class="toc-number">2.6.3.20.</span> <span class="toc-text">多值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dis_max"><span class="toc-number">2.6.3.21.</span> <span class="toc-text">dis_max</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#multi_match"><span class="toc-number">2.6.3.22.</span> <span class="toc-text">multi_match</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#search_template"><span class="toc-number">2.6.3.23.</span> <span class="toc-text">search_template</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#function_score_query"><span class="toc-number">2.6.3.24.</span> <span class="toc-text">function score query</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#suggester"><span class="toc-number">2.6.3.25.</span> <span class="toc-text">suggester</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#completion_suggester"><span class="toc-number">2.6.3.26.</span> <span class="toc-text">completion suggester</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#高亮"><span class="toc-number">2.6.3.27.</span> <span class="toc-text">高亮</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态词库"><span class="toc-number">2.7.</span> <span class="toc-text">动态词库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#重建索引"><span class="toc-number">2.8.</span> <span class="toc-text">重建索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#update_by_query"><span class="toc-number">2.8.1.</span> <span class="toc-text">update by query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reindex"><span class="toc-number">2.8.2.</span> <span class="toc-text">reindex</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#别名"><span class="toc-number">2.8.3.</span> <span class="toc-text">别名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据建模"><span class="toc-number">2.9.</span> <span class="toc-text">数据建模</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nested_data_type"><span class="toc-number">2.9.1.</span> <span class="toc-text">nested data type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#父子文档"><span class="toc-number">2.9.2.</span> <span class="toc-text">父子文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#script"><span class="toc-number">2.9.3.</span> <span class="toc-text">script</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/logo/" title="logo">logo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/IntelliJ-IDEA/" title="IntelliJ IDEA">IntelliJ IDEA<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/汇编/" title="汇编">汇编<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Mysql/" title="Mysql">Mysql<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://chenpeng.github.com" target="_blank" title="Blog">Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Chen Peng. <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2021 
		
		<a href="/about" target="_blank" title="Chen Peng">Chen Peng</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?null";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
